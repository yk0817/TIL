# ドメイン層の実装

## ドメインサービス


設計パターン

ドメインモデルを表現する設計パターンは大きくわけて、2種類にわかれる。
- 1.ドメインオブジェクト(ドメインモデルを表現するもの)
  - ドメインモデルを「モノ」として表現
    - エンティティ
    - 値オブジェクト
  - ドメインモデルを「コト」として表現
    - ドメインイベント
- 2.ドメインオブジェクト
  - リポジトリ
  - ファクトリー
  - ドメインサービス

## エンティティと値オブジェクトの違いは？

- 同一判定の方法が違う
  - エンティティは識別子で判定
  - 値オブジェクトは属性値(保持する値)で判定

## エンティティ

[参考記事](https://nrslib.com/clean-ddd-entity/)によると、ソフトウェアの文脈だと、
識別子≒idと考えて良さそう。

例) 社員番号1と100の山田さんがいたとする。身長や体重(属性値、特徴のこと)で判別するのでなく、
社員番号で区別する

## 値オブジェクト

本家DDD本の定義: あるオブジェクトが、ドメインにおける記述的な側面を表現し、概念的な同一性を持たない場合、そういうオブジェクトは、値オブジェクトと呼ばれる
ひらたくいうと、ものごとをidといった識別子ではなく、オブジェクトの特徴で表現することか？

[参考記事](https://qiita.com/wanko5296/items/8b470934cdc14f869a91)のメモ:
値オブジェクトの特徴は不変であること。また、特徴を記述する際には業務上のルールなどを表現し、仕様理解やバグの混入を防ぐ


所感: 通常おrailsだとvalidationに書いていたりして、一つのモデルに対してvalidation地獄におちいりがち。そして、なにより仕様把握しづらい。
validationといったビジネスルールを値オブジェクトに分散出来たら仕様理解しやすそう

## ドメインサービス

知識を1つのオブジェクトで答えられない時に用いる
例えば、メアド重複validation

肥大化しがちなので、なるべくエンティティと値オブジェクトを使うようにする。

## リポジトリ

集約単位で永続化層へのアクセスを提供するもの
設計上ポイントとなるのは、整合性を確実に保証する必要あり、ドメイン知識を持たないこと

## ファクトリー

生成の責務を持ったオブジェクト。生成ロジックが難しい、他の集約を参照する必要がある場合用いる

## 複数集約間の整合性確保
2つの方法がある。

- 1.ユースケース層のメソッドで確保
  - 本書で用いる
- 2.ドメインイベントを用いて結果整合性で確保
  - 実践ドメイン駆動本にのっているらしい

## QA

### ドメインにロジックを寄せる理由

安定依存の原則(多数のコンポーネントから依存されたコンポーネントは修正しづらくなるので、モジュールはより安定したモジュールに依存するべきだ)とドメイン層を独立させるという設計は安定依存の原則に沿っていない

ドメインにロジックを寄せる最大の理由はドメイン層を独立させて修正しやすくする。
修正影響はテストで担保する。ユースケースでテストをかけば実際に求められている動作が担保されているかわかる


